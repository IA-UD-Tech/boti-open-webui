name: Deploy PROD EC2 (tagged release only)

on:
  workflow_run:
    workflows: ["Create and publish Docker images with specific build args"]
    types:
      - completed
    branches:
      - main

permissions:
  contents: read
  packages: read

env:
  GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
  GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  WEBUI_SECRET_KEY_PROD: ${{ secrets.WEBUI_SECRET_KEY_PROD }}
  PIPELINES_API_KEY_PROD: ${{ secrets.PIPELINES_API_KEY_PROD }}
  
jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed to fetch all tags

      - name: Get current commit SHA
        id: get_sha
        run: |
          echo "sha=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_OUTPUT

      - name: Check if SHA matches a tag on main
        id: check_tag
        run: |
          TAG=$(git tag --contains ${{ steps.get_sha.outputs.sha }} | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' || true)
          if [ -z "$TAG" ]; then
            echo "No matching tag for commit ${{ steps.get_sha.outputs.sha }}. Skipping deploy."
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          else
            echo "Found tag: $TAG"
            echo "tag=$TAG" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
        shell: bash

      - name: Exit if no tag matched
        if: ${{ steps.check_tag.outputs.should_deploy != 'true' }}
        run: echo "Skipping deployment since no version tag is present."

      - name: Deploy to EC2 Prod
        if: ${{ steps.check_tag.outputs.should_deploy == 'true' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: boti.deusto.es
          username: ubuntu
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY_PROD }}
          envs: GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET, OPENAI_API_KEY, WEBUI_SECRET_KEY_PROD, PIPELINES_API_KEY_PROD
          script: |
            cd /home/ubuntu/app

            echo "üì• Downloading docker-compose.prod.yml from tag ${{ steps.check_tag.outputs.tag }}..."
            curl -L https://raw.githubusercontent.com/iaud-tech/boti-open-webui/${{ steps.check_tag.outputs.tag }}/docker-compose.dev.yml -o docker-compose.yml

            TAG=${{ steps.check_tag.outputs.tag }}

            echo "üîß Creating .env file..."
            cat <<EOF > .env
            ENV=prod
            WEBUI_NAME=Boti
            DEFAULT_LOCALE=es
            OPENAI_API_KEY=${OPENAI_API_KEY}
            WEBUI_SECRET_KEY=${WEBUI_SECRET_KEY_PROD}
            ENABLE_LOGIN_FORM=true
            ENABLE_OAUTH_SIGNUP=false
            GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
            GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
            WEBUI_URL=https://boti.deusto.es
            PIPELINES_API_KEY=${PIPELINES_API_KEY_PROD}
            OPEN_WEBUI_PORT=3000
            VERSION_TAG=$TAG
            EOF

            echo "üîå Ensuring Docker network 'caddy-net' exists..."
            docker network inspect caddy-net >/dev/null 2>&1 || docker network create caddy-net

            echo "‚¨áÔ∏è Pulling latest Docker images..."
            docker compose -f docker-compose.yml pull

            echo "üßπ Stopping old containers..."
            docker compose -f docker-compose.yml down

            echo "üöÄ Starting containers with updated images..."
            docker compose -f docker-compose.yml up -d

            echo "üßº Pruning unused images..."
            docker image prune -f

            echo "üóëÔ∏è Removing .env file with secrets..."
            rm .env



